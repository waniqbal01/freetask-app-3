generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  FREELANCER
  CLIENT
  ADMIN
}

enum JobStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  REJECTED
  DISPUTED
}

enum EscrowStatus {
  PENDING
  HELD
  DISPUTED
  RELEASED
  REFUNDED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model User {
  id               Int            @id @default(autoincrement())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  email            String         @unique
  password         String
  name             String
  role             UserRole
  avatarUrl        String?
  bio              String?
  skills           Json?
  rate             Decimal?       @db.Decimal(10, 2)
  services         Service[]
  jobsAsClient     Job[]          @relation("ClientJobs")
  jobsAsFreelancer Job[]          @relation("FreelancerJobs")
  messages         ChatMessage[]
  reviewsGiven     Review[]       @relation("ReviewerReviews")
  reviewsReceived  Review[]       @relation("RevieweeReviews")
  sessions         Session[]
  notifications    Notification[]
  deviceTokens     DeviceToken[]
  adminLogs        AdminLog[]
}

model Service {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  title        String
  description  String
  price        Decimal  @db.Decimal(10, 2)
  category     String
  thumbnailUrl String?
  freelancer   User     @relation(fields: [freelancerId], references: [id])
  freelancerId Int
  jobs         Job[]
}

model Job {
  id            Int           @id @default(autoincrement())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  title         String
  description   String
  amount        Decimal       @db.Decimal(10, 2)
  status        JobStatus     @default(PENDING)
  disputeReason String?
  service       Service       @relation(fields: [serviceId], references: [id])
  serviceId     Int
  client        User          @relation("ClientJobs", fields: [clientId], references: [id])
  clientId      Int
  freelancer    User          @relation("FreelancerJobs", fields: [freelancerId], references: [id])
  freelancerId  Int
  messages      ChatMessage[]
  reviews       Review[]
  escrow        Escrow?
  payment       Payment?
}

model ChatMessage {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  content       String
  type          String   @default("text")
  attachmentUrl String?
  sender        User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId      Int
  job           Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId         Int
}

model Review {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  rating     Int
  comment    String?
  job        Job      @relation(fields: [jobId], references: [id])
  jobId      Int
  reviewer   User     @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewerId Int
  reviewee   User     @relation("RevieweeReviews", fields: [revieweeId], references: [id], onDelete: Cascade)
  revieweeId Int

  @@unique([jobId, reviewerId, revieweeId])
  @@index([revieweeId])
}

model Escrow {
  id        Int          @id @default(autoincrement())
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  job       Job          @relation(fields: [jobId], references: [id])
  jobId     Int          @unique
  status    EscrowStatus @default(PENDING)
  amount    Decimal?     @db.Decimal(10, 2)
}

model Session {
  id                    Int      @id @default(autoincrement())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                Int
  refreshTokenHash      String?
  refreshTokenExpiresAt DateTime
  revoked               Boolean  @default(false)
  lastIp                String?
  userAgent             String?
}

model Notification {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  body      String
  read      Boolean  @default(false)
  type      String?
  data      Json?

  @@index([userId])
}

model DeviceToken {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  platform  String?

  @@index([userId])
}

model Payment {
  id             Int           @id @default(autoincrement())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  jobId          Int           @unique
  job            Job           @relation(fields: [jobId], references: [id])
  amount         Decimal       @db.Decimal(10, 2)
  status         PaymentStatus @default(PENDING)
  paymentMethod  String?
  transactionId  String?       @unique
  paymentGateway String?
}

model AdminLog {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  adminId   Int
  admin     User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  action    String
  resource  String?
  details   Json?

  @@index([adminId])
  @@index([createdAt])
}
